# 스프링, 클라우드와 만나다

## 마이크로서비스란?

마이크로서비스 개념 이전 대부분의 어플리케이션은 모놀리틱 아키텍쳐로 개발 했었드랬죠. 프론트 그리고, 그리고 비지니스 로직, 데이터베이스 접근 로직 등등 모두가 하나의 어플리케이션으로 패키징되고 배포 됐었죠.

암튼, 결정적으로 모놀리틱은 거대해지면 분야간에 엄청난 커뮤니케이션 비용과 복잡도가 생겨난다는거.

마이크로서비스의 특징을 정리하셨네요.
- 로직을 명확한 책임을 가진 컴포넌트로 분해해서 조화(책에는 "조합"이라고 했지만 뭔가 아쉬워서...)
- 각 컴포넌트는 작은 책임 영역을 담당하고, 상호 독립적으로 배포. 그리고 여러 애플리케이션에서 재사용 가능
- 데이터 교환으로 경량의 통신 프로토콜을 사용 (HTTP, JSON)
- 통신기술과 구현기술은 무관. 다양한 기술로 구축 가능 (Polyglot)
- 마지막 특징은 팀 구성하고 유지보수 관련 내용인것같은데 딱히 동의하지 않아 정리 안함

## 스프링은 무엇이고 마이크로서비스와 어떤 관련이 있을까?
스프링은 [spring.io]()를 참조하시고, 마이크로서비스를 구축하기에 적합. 요정도?!!!

## 책에서 다루는 내용
책을 보시고...

## 대상 독자
누구든 상관없다고 생각하는데...  
열정만 있다면... 😱오글오글~

## 스프링 부트로 마이크로서비스 구축
스프링 부트 `@RestController`로 엔드포인트를 잡고, [포스트맨](www.postman.com)으로 실행 해본다는 말씀이네요.

## 애플리케이션 구축 방식을 바꾸는 이유

####  복잡성이 증가함
여러 서비스들이 한데 어울어지길 원하는 고객의 니즈가 있대요.

#### 더 빠른 출시를 원함
모든 인간의 본능. 큰 덩어리로 뭉쳐진 것은 거추장스러워요. 기능별로 따로 번들링되어 있다면 필요한 부분만 단시간내에 업데이트 할 수 있겠죠.

#### 성능 및 확장성
글로우붤한 엔터프라이즈 환경의 특성상 사용자의 유입이 예측불허의 경향성이 있는데, 어플리케이션의 스케일 업 앤 다운이 용이한거죠.

#### 언제나 어플리케이션을 사용하길 원함
특정 기능의 장애로 전체 어플리케이션의 롹다운은 안된다는 거죠. 고객 이탈을 막기 위함과 장애 기능 단위의 회복력을 높일 수 있다는 거겠죠.
  
---  
마이크로서비스는 다음과 같은 특징의 시스템으로 구성된대요.

#### 유연성 flexible
새로운 기능을 빠르게 제공할 수 있는데, 그게 서비스를 분리하고 재구성할 수 있기 때문이란 거죠.  
당연히 분리된 작은 조각들은 복잡도가 낮고 다루기 편하기 때문에 테스트나 배포에도 유리하고요.

#### 회복성 resilient 
실패("장애"란 용어가 더 일반적인 것 같지만...)는 애플리케이션의 작은 부분에 국한돼 전체 장애로 확대되기 전에 억제되는 거죠. 

#### 확장성 scalable
분리된 서비스를 여러 시스템에 분산이 가능하니까 병목 지점에 대한 관리가 가능하겠네요. 

---
책 서론에선가? 마이크로서비스 아키텍쳐가 유용하지 않는 경우도 있을 수 있다고 했는데, "진리다" 싶을 정도로 추앙하고 있음.


## 클라우드란 정확히 무엇인가?
이 부분 참 맘에 들어요. iaas, pass, sass 를 음식에 빗대어 추상적으로 잘 설명한 부분이라고 생각하는데요.  

- Infrastructure as a Service
- Platform as a Service
- Service as a Service

로 봐도 대충 단어에서 감이 오죠.  
요즘은 클라우드 관련해서 몇가지 더 생긴 것도 있대요.
FaaS(Function as a Service), CaaS(Container as a Service) 같이 서버리스나 가상 컨테이너로 서비스 하는 것들을 얘기하는 거죠.

## 왜 클라우드와 마이크로서비스인가?
마이크로서비스의 핵심은 여러 서비스를 분리해서 독립된 형태로 개발하고 배포해서 빠르게 시작하고, 배포되는 서비스의 인스턴스가 여러곳에 분산될 때 동일한 기능을 수행해야 한다는 거죠.

그래서 가상 머신 이미지나 가상 컨테이너 형태가 적합하고, 물리적인 서버(On-Promise)에는 적합하지 않겠다고 금방 이해되겠죠?  
클라우드에 기반한 마이크로서비스는 탄력성을 확보하는 거죠. 스케일 업다운이 원할하고 심지어 능동적으로 그런 플랫폼이 제공되니까요.

## 마이크로서비는 코드 작성 이상을 의미
~~문단 제목이 별로네.~~ 지금까지 살펴본 구축 관련한 개념은 이해하기 쉬운데 실제로 서비스(또는 컴포넌트)를 어떤 기준으로 분리해서 견고하게 마이크로서비스로 만드는지는 어렵단 얘긴가봐요.

#### 적정 크기
과도한 책임을 맡지 않고 적절한 크기로 만들지 고민 해봐야겠어요.  
그랬을때, 빠르게 만들고 변경하고 전체적인 장애에서 빗겨날 수 있으니까요.

#### 위치 투명성
서비스가 여러개의 인스턴스로 확장됐을 때, 각각의 이력을 관리하고 추적할 수 있어야겠죠?

#### 회복성
빨리 실패하거나 장애를 우회하는 방법등, 고객의 이탈을 방지하고 무결성을 확보하는 방법도 알아야 하고.

#### 확장성
비동기와 이벤트 처리 방식등을 사용해서 서비스간에 의존성을 줄이고 원만하게 확장하는 방법도 고민해봐요.


### 마이크로서비스 핵심 개발 패턴
개발할 때는 역시 패턴이 있어야겠죠?

#### 서비스 세분성
하나의 서비스가 다른 비지니스 문제 영역과 책임이 겹치도록 굵게 나누면(coarse-grained) 유지보수도 어렵고 품이 더 많이 들 수 있겠죠? 반면에 너무 잘게 나뉘면(fine-grained) 전반적인 복잡성이 증가하고(그런가? 앞에선 작게 나누면 복잡성이 준다고 했었는데... 아닌가?!) 서비스가 특정 기술의 부산물 수준이 될 수 있다고 해요. 데이터 저장소에 접근하는 것 외에 로직이 없는 그런 서비스가 될 수 있다는 거죠.

#### 통신 프로토콜
json 쓰는 거죠. [Thrift](thrift.apache.org) 같은 바이너리 프로토콜도 좋긴 한데, 직관성이 좀 떨어지는 것 같아서요. json 은 네트웍 캡쳐해서도 바로 읽을 수 있으니깐...

#### 인터페이스 설계
서비스의 접합점. 즉, 인터페이스를 잘 설계하는 방법은 구조화된 URI 구성?

#### 서비스 간 이벤트 프로세싱
서비스간에 하드코딩된 IP 나 도메인을 제거해서 의존성을 줄이고 회복성을 높이기 위한 분리의 방법이 뭘까요?

### 마이크로서비스 라우팅 패턴
이전에 한 얘길 반복하는 것 같은데, 서비스의 물리적인 위치를 발견하고 라우팅하려면 단일진입점을 만들고 물리적인 위치를 추상화 해야 하는데 **서비스 디스커버리**나 **서비스 라우팅**이 필요하겠어요.

### 마이크로서비스 클라이언트 회복성 패턴
고도로 분산되어 있는 마이크로서비스가 소비자에게 연쇄적으로 발생하지 않도록 **클라이언트 분산 부하**, **회로 차간기 패턴**, **폴백 패턴**, **벌크해드 패턴** 이 있군요.

### 마이크로서비스 보안 패턴
분리된 서비스에서 **인증(Authentication)** (그냥 로그인 하는 거겠죠?), **인가(Authorization)** (권한 관리 같은 거?!), **자격증명(Credential) 관리와 전파(Propagation)** 를 위해서 OAuth와 JWT 같은 것들이 필요하겠어요.

### 마이크로서비스 로깅 및 추적 패턴
독립적으로 분리된 배포라 되면서 통합된 로깅이나 추적이 까다로울 것 같아요. **로그 상관관계(log correlation)** 를 위해서 Passport 같은 고유ID를 부여해서 서비스간에 통용하고 **로그 수집(log aggregation)** 해서 query 가능한 DB로 취합해서 조회할 필요가 있겠어요. 서비스간에 고유ID로 발생된 트랜젝션을 **추적(tracing)** 해서 흐름을 이해하고 시각화도 하는 쿵짝쿵짝이 필요할 것 같아요.

### 마이크로서비스 빌드 및 배포 패턴
분산된 서비스 인스턴스들이 모두 동일해야 하잖아요. 근데, 그게 쉽지 않을 것 같네요. 서비스 구성 환경의 편차(있어보이는 말로 "구성편차(configuration drift)"라고 한대요)를 극복하기 위해선 어플리케이션의 패키지 형태가 아닌 가상화된 이미지로 배포를 하는게 유리하다는 군요. 지속적인 통합(CI)와 **불변 서버(Immutable Server)**나 **피닉스 서버(Phoenix server)** 등으로 변형없고 정기적인 서비스 재기동을 위한 조치도 필요하다고 해요.


## 스프링 클라우드로 마이크로서비스 구축
스프링 클라우드의 여러 기술을 간단히 살펴보자는데, 책의 장표가 아주 적절하게 설명하고 있어요.

### 스프링 부트
RESTful 서비스를 개발하기 쉽고 직렬화와 역직열화 등등 개발에 많이 도움 되죠.

### 스프링 클라우드 컨피그
중앙 집중식으로 애플리케이션 구성 데이터를 관리하고 마이크로서비스 인스턴스들과 완전히 분리되어 있대요. 스케일 업 되고 인스턴스가 많아져도 동일한 구성을 유지하고요.

### 스프링 클라우드 서비스 디스커버리
서비스가 배포된 물리적인 위치를 추상화 해줘요.

### 스프링 클라우드 / 넷플릭스 히스트릭스 
회로차단기와 벌크해드같은 서비스 클라이언트의 회복성 패턴을 신속하게 구현할 수 있대요.

### 스프링 클라우드 / 넷플릭스 주울
게이트웨이 역할을 하는 거죠. 하나의 통로를 통해 요청을 라우팅 시켜주는 식.

### 스프링 클라우드 스트림
경량의 메세지 프로세싱을 쉽게 통합해 준대요. MQ 같은 거?!

### 스프링 클라우스 슬루스
각 서비스 간에 HTTP 호출이나 메세지 채널들에게 고유 ID를 발급해서 추적할 수 있게 해준대요. 로그 수집 및 추적 할때 쓰이겠네요.

### 스프링 클라우드 시큐리티
보안 관련사항 일체 담당하겠죠, 뭐...

### 프로비저닝
개발은 했는데 CI 는 어쩌나... Travis 랑 Docker 를 쓰지요.


## 예재로 배우는 스프링 클라우드 
코드 참조 [Chapter01Application.java](./Chapter01Application.java) 

## 예제와 관련성 확인
가상의 회사를 설정하고 새로운 MSA 프로젝트를 시행한다는 시나리오

## 요약
내가 지금까지 정리한게 이미 요약 :)
